<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lunaverse</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #000; font-family: sans-serif; }
        #game-stage {
            width: 100vw; height: 100vh;
            background: url('lunaverse_wallpaper.PNG') no-repeat center center;
            background-size: cover;
            position: relative;
            transition: opacity 4s ease-out;
        }
        .sprite { position: absolute; pointer-events: none; z-index: 20; }
        @keyframes walkEast { from { left: -250px; } to { left: 110vw; } }
        .zoom-east { animation: walkEast 4s linear forwards; }
        .sparkle { position: absolute; pointer-events: none; transition: all 0.8s ease-out; font-size: 24px; z-index: 15; }
        
        #end-screen {
            display: none;
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            text-align: center;
            z-index: 100;
        }
    </style>
</head>
<body>

    <div id="game-stage">
        <img id="grandma" src="preserved_lemon .png" style="display:none; position:absolute; bottom:0; left:0; width:200px; z-index:30;">
        
        <div id="end-screen">
            <h1 style="font-size: 2.5rem;">✨ Magic Time Over ✨</h1>
            <p>Time for a snack or a nap!</p>
        </div>
    </div>

<script>
    const stage = document.getElementById('game-stage');
    const grandma = document.getElementById('grandma');
    const endScreen = document.getElementById('end-screen');
    let currentAudio = null;
    let gameActive = true;

    // --- HELPER FUNCTION: PLAY SOUND (Aggressive Stop for No Overlap) ---
    function playSound(file, interrupt = true) {
        if (currentAudio && interrupt) {
            currentAudio.pause();
            currentAudio.currentTime = 0;
            currentAudio = null; 
        }
        
        currentAudio = new Audio(file);
        currentAudio.volume = 0.5; 
        
        const playPromise = currentAudio.play();
        if (playPromise !== undefined) {
            playPromise.catch(error => console.log("Audio block:", error));
        }
    }

    // --- TAP HANDLER ---
    function handleTap(e) {
        if (!gameActive) return;

        // 1. Sparkle Trail
        const star = document.createElement('div');
        star.className = 'sparkle';
        star.innerHTML = '✨';
        star.style.left = e.clientX + 'px';
        star.style.top = e.clientY + 'px';
        stage.appendChild(star);
        setTimeout(() => {
            star.style.transform = 'translateY(-50px) scale(0)';
            star.style.opacity = '0';
        }, 10);
        setTimeout(() => star.remove(), 800);

        // 2. SPECIAL MOON TAP
        const moonZoneX = window.innerWidth * 0.25;
        const moonZoneY = window.innerHeight * 0.25;
        
        if (e.clientX < moonZoneX && e.clientY < moonZoneY) {
            const unicorn = document.createElement('img');
            unicorn.src = 'luna_unicorn.png';
            unicorn.className = 'sprite';
            unicorn.style.left = (e.clientX - 100) + 'px';
            unicorn.style.top = (e.clientY - 100) + 'px';
            unicorn.style.width = '250px'; 
            stage.appendChild(unicorn);
            
            playSound('luna_whisper.mp3', true); 
            setTimeout(() => unicorn.remove(), 3000);
            return; 
        }

        // 3. RANDOM LOGIC & AUDIO
        const randomChance = Math.random();
        const sounds = ['Luna-moon-Stella-star.mp3', 'luna_whisper.mp3', 'happy-day.mp3'];
        
        playSound(sounds[Math.floor(Math.random() * sounds.length)], true);

        if (randomChance < 0.1) {
            grandma.style.display = 'block';
            setTimeout(() => { grandma.style.display = 'none'; }, 3000);
        }

        if (randomChance > 0.7) { // Zoomers
            const zoomers = ['blue_azul_front.png', 'cardboard_tank.png', 'mochkil_walk_right_cake.png'];
            const z = document.createElement('img');
            z.src = zoomers[Math.floor(Math.random() * zoomers.length)];
            z.className = 'sprite zoom-east';
            z.style.top = Math.random() * 60 + 10 + '%';
            z.style.width = '180px';
            stage.appendChild(z);
            setTimeout(() => z.remove(), 4500);
        } else { // Poppers
            const poppers = ['Stella.png', 'elina_stella.png', 'friend1.png', 'luna_kitty.png', 'luna_unicorn.png', 'read_cloud.png', 'stella_star.png'];
            const p = document.createElement('img');
            p.src = poppers[Math.floor(Math.random() * poppers.length)];
            p.className = 'sprite';
            p.style.left = (e.clientX - 75) + 'px';
            p.style.top = (e.clientY - 75) + 'px';
            p.style.width = '160px';
            stage.appendChild(p);
            setTimeout(() => p.remove(), 2500);
        }
    }

    stage.addEventListener('click', handleTap);

    // --- AUTO-END AFTER 2 MINUTES ---
    setTimeout(() => {
        gameActive = false;
        document.querySelectorAll('.sprite, .sparkle').forEach(el => el.remove());
        if (currentAudio) {
            currentAudio.pause();
            currentAudio.currentTime = 0;
        }
        playSound('goodnight-adventure.mp3', true);
        stage.style.opacity = 0.3;
        endScreen.style.display = 'block';
    }, 120000);
</script>

</body>
</html>
