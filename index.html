<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lunaverse</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #000; font-family: sans-serif; }
        #game-stage {
            width: 100vw; height: 100vh;
            background: url('lunaverse_wallpaper.PNG') no-repeat center center;
            background-size: cover;
            position: relative;
            transition: opacity 4s ease-out;
        }
        <style>
    .sprite { 
        position: absolute; 
        pointer-events: none; 
        z-index: 20; 
        will-change: transform, opacity; /* Optimizes for iPhone GPU */
        transition: transform 0.3s ease-out;
    }
    
    /* Let's make the sparkles more "Maximum Reality" style */
    .sparkle {
        position: absolute;
        pointer-events: none;
        font-size: 30px;
        z-index: 100;
        animation: flyUp 0.8s ease-out forwards;
    }

    @keyframes flyUp {
        0% { transform: translateY(0) scale(1); opacity: 1; }
        100% { transform: translateY(-100px) scale(0); opacity: 0; }
    }
</style>

<script>
    // Use pointerdown for instant response on iPhone
    stage.addEventListener('pointerdown', (e) => {
        e.preventDefault(); // Prevents zooming/scrolling while tapping
        handleTap(e);
    });

    // Modified handleTap for better hit detection
    function handleTap(e) {
        if (!gameActive) return;

        // Sparkle logic
        const star = document.createElement('div');
        star.className = 'sparkle';
        star.innerHTML = '✨';
        star.style.left = `${e.clientX - 15}px`;
        star.style.top = `${e.clientY - 15}px`;
        stage.appendChild(star);
        setTimeout(() => star.remove(), 800);

        // Moon Zone detection (Top Left)
        if (e.clientX < window.innerWidth * 0.3 && e.clientY < window.innerHeight * 0.2) {
            spawnSpecial('luna_unicorn.png', e.clientX, e.clientY, 'luna_whisper.mp3');
            return;
        }

        // Random Character Logic
        const chance = Math.random();
        if (chance > 0.8) {
            spawnZoomer(); // Azul or Mochkil
        } else {
            spawnPopper(e.clientX, e.clientY);
        }
    }

    function spawnPopper(x, y) {
        const poppers = ['Stella.png', 'luna_kitty.png', 'stella_star.png'];
        const img = document.createElement('img');
        img.src = poppers[Math.floor(Math.random() * poppers.length)];
        img.className = 'sprite';
        img.style.left = `${x - 80}px`;
        img.style.top = `${y - 80}px`;
        img.style.width = '160px';
        stage.appendChild(img);
        
        playSound(audioFiles[Math.floor(Math.random() * 3)]);
        setTimeout(() => img.remove(), 2000);
    }
</script>

</head>
<body>

    <div id="game-stage">
        <img id="grandma" src="preserved_lemon .png" style="display:none; position:absolute; bottom:0; left:0; width:200px; z-index:30;">
        
        <div id="end-screen">
            <h1 style="font-size: 2.5rem;">✨ Magic Time Over ✨</h1>
            <p>Time for a snack or a nap!</p>
        </div>
    </div>

<script>
    const stage = document.getElementById('game-stage');
    const grandma = document.getElementById('grandma');
    const endScreen = document.getElementById('end-screen');
    let currentAudio = null;
    let gameActive = true;

    // --- 1. SIGNAL-PROOF PRELOADING ---
    const audioCache = {};
    const audioFiles = ['Luna-moon-Stella-star.mp3', 'luna_whisper.mp3', 'happy-day.mp3', 'goodnight-adventure.mp3'];

    audioFiles.forEach(file => {
        const audio = new Audio(file);
        audio.preload = 'auto'; 
        audioCache[file] = audio;
    });

    // --- 2. UNIFIED HELPER FUNCTION (Uses Cache + Stops Overlap) ---
    function playSound(file, interrupt = true) {
        if (currentAudio && interrupt) {
            currentAudio.pause();
            currentAudio.currentTime = 0;
        }
        
        // Pull from cache so it plays instantly without needing more signal
        currentAudio = audioCache[file];
        
        if (currentAudio) {
            currentAudio.volume = 0.5;
            const playPromise = currentAudio.play();
            if (playPromise !== undefined) {
                playPromise.catch(e => console.log("Audio block:", e));
            }
        }
    }

    // --- 3. TAP HANDLER ---
    function handleTap(e) {
        if (!gameActive) return;

        // Sparkle Trail
        const star = document.createElement('div');
        star.className = 'sparkle';
        star.innerHTML = '✨';
        star.style.left = e.clientX + 'px';
        star.style.top = e.clientY + 'px';
        stage.appendChild(star);
        setTimeout(() => {
            star.style.transform = 'translateY(-50px) scale(0)';
            star.style.opacity = '0';
        }, 10);
        setTimeout(() => star.remove(), 800);

        // SPECIAL MOON TAP
        const moonZoneX = window.innerWidth * 0.25;
        const moonZoneY = window.innerHeight * 0.25;
        
        if (e.clientX < moonZoneX && e.clientY < moonZoneY) {
            const unicorn = document.createElement('img');
            unicorn.src = 'luna_unicorn.png';
            unicorn.className = 'sprite';
            unicorn.style.left = (e.clientX - 100) + 'px';
            unicorn.style.top = (e.clientY - 100) + 'px';
            unicorn.style.width = '250px'; 
            stage.appendChild(unicorn);
            
            playSound('luna_whisper.mp3', true); 
            setTimeout(() => unicorn.remove(), 3000);
            return; 
        }

        // RANDOM LOGIC & AUDIO
        const randomChance = Math.random();
        const sounds = ['Luna-moon-Stella-star.mp3', 'luna_whisper.mp3', 'happy-day.mp3'];
        
        playSound(sounds[Math.floor(Math.random() * sounds.length)], true);

        if (randomChance < 0.1) {
            grandma.style.display = 'block';
            setTimeout(() => { grandma.style.display = 'none'; }, 3000);
        }

        if (randomChance > 0.7) { // Zoomers
            const zoomers = ['blue_azul_front.png', 'cardboard_tank.png', 'mochkil_walk_right_cake.png'];
            const z = document.createElement('img');
            z.src = zoomers[Math.floor(Math.random() * zoomers.length)];
            z.className = 'sprite zoom-east';
            z.style.top = Math.random() * 60 + 10 + '%';
            z.style.width = '180px';
            stage.appendChild(z);
            setTimeout(() => z.remove(), 4500);
        } else { // Poppers
            const poppers = ['Stella.png', 'elina_stella.png', 'friend1.png', 'luna_kitty.png', 'luna_unicorn.png', 'read_cloud.png', 'stella_star.png'];
            const p = document.createElement('img');
            p.src = poppers[Math.floor(Math.random() * poppers.length)];
            p.className = 'sprite';
            p.style.left = (e.clientX - 75) + 'px';
            p.style.top = (e.clientY - 75) + 'px';
            p.style.width = '160px';
            stage.appendChild(p);
            setTimeout(() => p.remove(), 2500);
        }
    }

    stage.addEventListener('click', handleTap);

    // --- 4. AUTO-END AFTER 2 MINUTES ---
    setTimeout(() => {
        gameActive = false;
        document.querySelectorAll('.sprite, .sparkle').forEach(el => el.remove());
        if (currentAudio) {
            currentAudio.pause();
            currentAudio.currentTime = 0;
        }
        playSound('goodnight-adventure.mp3', true);
        stage.style.opacity = 0.3;
        endScreen.style.display = 'block';
    }, 120000);
</script>

</body>
</html>
